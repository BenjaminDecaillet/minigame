<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matthew's Gift</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;700&family=Bebas+Neue&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e313b;
            --accent: #f59e0b;
            --text: #f1f5f9;
            --security: #92400e;
            --gaffeur: #22c55e;
            --bricoleur: #dc2626;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        #app {
            width: 95%;
            max-width: 600px;
        }

        .card {
            background: var(--card);
            padding: 2.5rem;
            border-radius: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            animation: fadeIn 0.5s ease-out;
        }

        h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3.5rem;
            margin-bottom: 0.5rem;
            color: var(--accent);
        }

        .score-box {
            display: flex;
            justify-content: space-around;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            font-weight: bold;
        }

        p {
            font-size: 1.1rem;
            color: #cbd5e1;
            margin-bottom: 2rem;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        button {
            padding: 1.2rem;
            border: none;
            border-radius: 1rem;
            background: #334155;
            color: white;
            cursor: pointer;
            transition: 0.3s;
            font-weight: 600;
            font-size: 1rem;
        }

        button:hover {
            background: var(--accent);
            color: var(--bg);
            transform: scale(1.02);
        }

        #game-zone {
            background: radial-gradient(circle, #1e293b 0%, #020617 100%);
            border-radius: 1.5rem;
            position: relative;
            height: 400px;
            overflow: hidden;
            margin-bottom: 1.5rem;
            border: 3px solid var(--accent);
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.8);
        }

        .game-ui {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            z-index: 10;
            pointer-events: none;
        }

        .progress-container {
            width: 100px;
            height: 10px;
            background: #334155;
            border-radius: 5px;
            overflow: hidden;
            border: 1px solid var(--accent);
        }

        .progress-bar {
            width: 0%;
            height: 100%;
            background: var(--accent);
            transition: width 0.3s ease;
        }

        .lapsus {
            position: absolute;
            padding: 12px 20px;
            background: white;
            color: var(--bg);
            border-radius: 50px;
            cursor: pointer;
            font-weight: 800;
            font-size: 0.9rem;
            white-space: nowrap;
            user-select: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.1s, opacity 0.3s;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .stain {
            position: absolute;
            width: 40px;
            height: 40px;
            background: #991b1b;
            border-radius: 50%;
            cursor: pointer;
            filter: blur(2px);
            transition: transform 0.2s;
        }

        .cat-bonus {
            position: absolute;
            font-size: 2.5rem;
            cursor: pointer;
            z-index: 5;
            user-select: none;
        }

        .game-over-overlay {
            position: absolute;
            inset: 0;
            background: rgba(15, 23, 42, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            gap: 15px;
            animation: fadeIn 0.3s ease;
        }

        .floating-icon {
            position: absolute;
            font-size: 2.5rem;
            cursor: pointer;
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.5));
            user-select: none;
            transition: transform 0.1s;
        }

        @keyframes popIn {
            from {
                transform: scale(0);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes shake {
            0% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }

            100% {
                transform: translateX(0);
            }
        }

        .shake {
            animation: shake 0.2s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        @keyframes glow {
            0%, 100% {
                filter: drop-shadow(0 0 5px var(--accent));
            }
            50% {
                filter: drop-shadow(0 0 20px var(--accent));
            }
        }

        @keyframes spark {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }

        .spark {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            pointer-events: none;
            animation: spark 0.8s ease-out forwards;
        }
    </style>
</head>

<body>

    <audio id="duck-sound" src="https://www.myinstants.com/media/sounds/quack.mp3"></audio>
    <audio id="cartoon-hammer" src="https://www.myinstants.com/media/sounds/cartoon-hammer.mp3"></audio>
    <audio id="rock-mining" src="https://www.myinstants.com/media/sounds/y2mate_XL9ozUG.mp3"></audio>
    <audio id="aw-sound" src="https://www.myinstants.com/media/sounds/awwsoundheh.mp3"></audio>
    <audio id="rizz-sound" src="https://www.myinstants.com/media/sounds/ta-da_yrvBrlS.mp3"></audio>
    <audio id="fart-sound" src="https://www.myinstants.com/media/sounds/dry-fart.mp3"></audio>
    <audio id="pewpew" src="https://www.myinstants.com/media/sounds/pew_pew-dknight556-1379997159.mp3"></audio>
    <audio id="ouch" src="https://www.myinstants.com/media/sounds/ouch-that-hurt.mp3"></audio>
    <audio id="marioJump" src="https://www.myinstants.com/media/sounds/maro-jump-sound-effect_1.mp3"></audio>
    <audio id="bricoleur-sound" src="https://www.myinstants.com/media/sounds/angle-grinder.mp3"></audio>
    <audio id="security" src="https://www.myinstants.com/media/sounds/what-a-good-boy.mp3"></audio>

    <div id="app"></div>

    <script>
        const app = document.getElementById('app');
        const cartoonHammerSound = document.getElementById('cartoon-hammer');
        const rockMiningSound = document.getElementById('rock-mining');
        const pewpew = document.getElementById('pewpew');
        const awSound = document.getElementById('aw-sound');
        const rizzSound = document.getElementById('rizz-sound');
        const fartSound = document.getElementById('fart-sound');
        const ouch = document.getElementById('ouch');
        const mario_jump = document.getElementById('marioJump'); 
        const bricoleur = document.getElementById('bricoleur-sound');
        const security = document.getElementById('security');

        let state = {
            stepIndex: 0,
            scores: { security: 0, gaffeur : 0, bricoleur: 0 }
        };

        const story = [
            {
                title: "Matthew's Gift Quest",
                text: "Bienvenue Matthew! Pour trouver ton cadeau, tu devras relever des d√©fis et faire des choix. Pr√™t √† commencer¬†?",
                options: [{ text: "D√©marrer", score: { fart: 1 }, next: true }]
            },
            {
                title: "Les bases du bricolage",
                text: "Tu as besoin d'accrocher un cadre au mur. Que fais-tu ?",
                options: [
                    { text: "J'arr√™te tout et j'appelle mon beau-fr√®re pr√©f√©r√©! Lui il saura quoi faire !", score: { gaffeur: 1 }, next: true },
                    { text: "Je prends un clou et c'est parti!", score: { bricoleur: 1 }, next: true },
                    { text: "Je sors la perceuse, les bouts de lambourdes qu'il me reste, la scie circulaire, une √©chelle, un casque de soudure,.... mais d'abord, je bois une bi√®re!", score: { security: 1 }, next: true }
                ]
            },
            {
                title: "JEU : Wood Hunter",
                text: "CONSIGNE : Pour la base de ton cadeau, r√©cup√®re le bois qui tombe du ciel !",
                type: 'game',
                gameType: 'woodcatch',
                next: true
            },
            {
                title: "Tes reflexes de bricoleur pro",
                text: "Tu dois enfiler des clous dans un trou de 2mm. Combien de doigts vas-tu taper avant de r√©ussir ?",
                options: [
                    { text: "Aucun je suis un pro ", score: { bricoleur: 1 }, next: true },
                    { text: "Est-ce que la zone de travail est conforme aux normes de s√©curit√© en vigueur? ", score: { security: 1 }, next: true },
                    { text: "Enfiler des quoi ?", score: { gaffeur: 1 }, next: true }
                ]
            },
            {
                title: "JEU : Mine de M√©tal",
                text: "CONSIGNE : Clique rapidement sur chaque rocher pour extraire le m√©tal pr√©cieux afin de finir ta collection de mat√©riel!",
                type: 'game',
                gameType: 'rockmining',
                next: true
            },
            {
                title: "JEU : Reflexe du bricoleur pro",
                text: "CONSIGNE : Des vers tentent de s'attaquer √† tes pr√©cieux mat√©riaux √©crase les avant qu'il soient d√©vor√©s !",
                type: 'game',
                gameType: 'bugwhack',
                next: true
            },
            {
                title: "Et les protections dans tout √ßa?",
                text: "Tu bricoles d'accord, mais portes tu les protections n√©cessaires ?",
                options: [
                    { text: "Evidemment! Tu sais dans mon dernier job j'√©tais charg√© de la s√©curit√© de toute la commune de Conthey !", score: { security: 1 }, next: true },
                    { text: "Le bon bricoleur il prend son marteau et il frappe. Le mauvais bricoleur il prend son marteau et il frappe, mais c'est pas pareil !", score: { bricoleur: 1 }, next: true },
                    { text: "Les protections c'est pour les faibles !", score: { gaffeur: 1 }, next: true }
                ]
            },
            {
                title: "JEU : Construis ton cadeau en rythme!",
                text: "Maintenant  que tu es √©quip√© et prot√©g√©, il est temps de construire ton cadeau! Utilise ton marteau pour assembler les pi√®ces !",
                type: 'game',
                gameType: 'rythmicForge',
                next: true
            },
            {
                title: "JEU : Sauve ton pied !",
                text: "CONSIGNE : Ton marteau forg√©, maintien le en l'air et √©vite qu'il n'√©crase ton pied !",
                type: 'game',
                gameType: 'hammerclick',
                next: true
            },
            {
                title: "L'Analyse Finale",
                text: "Matthew, le parcours est termin√©. Ton destin est scell√©. D√©couvre ton cadeau",
                options: [{ text: "Voir ton cadeau", next: true }]
            }
        ];

        function render() {
            if (state.stepIndex >= story.length) return renderResult();
            const node = story[state.stepIndex];

            app.innerHTML = `
            <div class="card">
                <div class="score-box">
                    <span style="color:var(--security)">ü™µ Bricoleur: ${state.scores.bricoleur}</span>
                    <span style="color:var(--gaffeur)">üêõ Gaffeur: ${state.scores.gaffeur}</span>
                    <span style="color:var(--hammer)">üî® S√©curit√©: ${state.scores.security}</span>
                </div>
                <h1>${node.title}</h1>
                <p>${node.text}</p>
                <div class="options">
                    ${node.type === 'game' ? `<button onclick="launchGame('${node.gameType}')">JOUER</button>` : renderOptions(node.options)}
                </div>
            </div>
        `;
        }

        function renderOptions(options) {
            return options.map(opt => `<button onclick="handleChoice(${JSON.stringify(opt.score || null).replace(/"/g, '&quot;')})">${opt.text}</button>`).join('');
        }

        window.handleChoice = (score) => {
            if (score) {
                if (score.security) security.play();
                if (score.gaffeur) ouch.play();
                if (score.bricoleur) bricoleur.play();
                for (let key in score) state.scores[key] += score[key];
            }
            state.stepIndex++;
            render();
        };

        function showEndGameMenu(msg, points, type) {
            const zone = document.getElementById('game-zone');
            const overlay = document.createElement('div');
            overlay.className = 'game-over-overlay';
            overlay.innerHTML = `
                <h2 style="color:var(--accent); margin:0;">${msg}</h2>
                <div style="display:flex; gap:10px;">
                    <button onclick="launchGame('${type}')" style="background:#475569; padding: 0.8rem 1.2rem;">R√âESSAYER</button>
                    <button onclick="handleChoice(${JSON.stringify(points).replace(/"/g, '&quot;')})" style="background:var(--accent); color:var(--bg); padding: 0.8rem 1.2rem;">CONTINUER</button>
                </div>
            `;
            zone.appendChild(overlay);
        }

        window.launchGame = (type) => {
            const card = document.querySelector('.card');
            card.innerHTML = `
                <div class="game-ui">
                    <div id="game-msg" style="color:var(--accent); font-weight:bold;">SCORE: <span id="g-score">0</span></div>
                    <div class="progress-container"><div id="p-bar" class="progress-bar"></div></div>
                </div>
                <div id="game-zone"></div>
            `;

            const zone = document.getElementById('game-zone');
            const pBar = document.getElementById('p-bar');
            const gScore = document.getElementById('g-score');

            const updateProgress = (current, total) => {
                pBar.style.width = (current / total * 100) + '%';
            };

            if (type === 'woodcatch') {
                zone.innerHTML += `<div id="basket" style="position:absolute; bottom:20px; left:50%; transform:translateX(-50%); font-size:4rem; transition: left 0.1s; user-select:none;">üß∫</div>`;
                const basket = document.getElementById('basket');
                let basketPos = 50; // percentage
                let caught = 0;
                let missed = 0;
                const goal = 15;
                const maxMissed = 5;
                let gameActive = true;

                // Mouse control
                zone.onmousemove = (e) => {
                    const rect = zone.getBoundingClientRect();
                    basketPos = ((e.clientX - rect.left) / rect.width) * 100;
                    basketPos = Math.max(5, Math.min(95, basketPos));
                    basket.style.left = basketPos + '%';
                };

                const spawnWood = () => {
                    if (!document.getElementById('game-zone') || !gameActive) return;
                    const wood = document.createElement('div');
                    wood.innerHTML = 'ü™µ';
                    wood.style.cssText = `position:absolute; left:${Math.random() * 90}%; top:-50px; font-size:2rem; user-select:none;`;
                    zone.appendChild(wood);

                    let woodY = -50;
                    let woodX = parseFloat(wood.style.left);
                    const fallInterval = setInterval(() => {
                        woodY += 5;
                        wood.style.top = woodY + 'px';

                        // Check collision with basket
                        if (woodY > zone.offsetHeight - 80 && woodY < zone.offsetHeight - 40) {
                            if (Math.abs(woodX - basketPos) < 8) {
                                clearInterval(fallInterval);
                                wood.remove();
                                caught++;
                                // rizzSound.play();
                                gScore.innerText = caught;
                                updateProgress(caught, goal);

                                if (caught >= goal) {
                                    gameActive = false;
                                    clearInterval(spawnLoop);
                                    zone.onmousemove = null;
                                    showEndGameMenu("ALL WOOD CAUGHT! ü™µ", { wood: 2 }, type);
                                }
                            }
                        }

                        // Missed the basket
                        if (woodY > zone.offsetHeight) {
                            clearInterval(fallInterval);
                            wood.remove();
                            missed++;
                            fartSound.play();
                            if (missed >= maxMissed) {
                                gameActive = false;
                                clearInterval(spawnLoop);
                                zone.onmousemove = null;
                                showEndGameMenu("TOO MUCH WASTED WOOD!", { wood: 0 }, type);
                            }
                        }
                    }, 30);
                };

                const spawnLoop = setInterval(() => {
                    if (!document.getElementById('game-zone') || !gameActive) {
                        clearInterval(spawnLoop);
                        return;
                    }
                    spawnWood();
                }, 800);
            }

            if (type === 'bugwhack') {
                zone.innerHTML += `<div style="position:absolute; inset:0; center/80% no-repeat;"></div>`;
                let whacked = 0;
                const goal = 20;
                let spawnRate = 800;

                const spawnBug = () => {
                    if (!document.getElementById('game-zone')) return;
                    const bug = document.createElement('div');
                    bug.innerHTML = 'üêõ';
                    bug.style.cssText = `position:absolute; left:${Math.random() * 85}%; top:${Math.random() * 85}%; font-size:2.5rem; cursor:pointer; user-select:none; animation: popIn 0.3s;`;
                    zone.appendChild(bug);

                    const bugLife = setTimeout(() => {
                        if (bug.parentNode) {
                            bug.remove();
                        }
                    }, 1500 - (whacked * 30)); // Bugs disappear faster as you progress

                    bug.onclick = () => {
                        clearTimeout(bugLife);
                        bug.innerHTML = 'üí•';
                        cartoonHammerSound.currentTime = 0;
                        cartoonHammerSound.play();
                        whacked++;
                        gScore.innerText = whacked;
                        updateProgress(whacked, goal);
                        setTimeout(() => bug.remove(), 200);

                        if (whacked >= goal) {
                            clearInterval(gameLoop);
                            showEndGameMenu("ALL BUGS EXTERMINATED! üî®", { bug: 2 }, type);
                        }

                        // Increase difficulty
                        if (whacked % 5 === 0 && spawnRate > 300) {
                            spawnRate -= 100;
                        }
                    };
                };

                let gameLoop = setInterval(() => {
                    spawnBug();
                }, spawnRate);

                // Spawn initial bugs
                for (let i = 0; i < 3; i++) {
                    setTimeout(spawnBug, i * 300);
                }
            }

            if (type === 'hammerclick') {
                zone.innerHTML += `
                    <div id="foot" style="position:absolute; bottom:20px; left:50%; transform:translateX(-50%); font-size:4rem; user-select:none;">ü¶∂</div>
                    <div id="hammer-fall" style="position:absolute; left:50%; top:50px; transform:translateX(-50%); font-size:3.5rem; cursor:pointer; user-select:none; transition: top 0.05s linear;">üî®</div>
                    <div style="position:absolute; top:10px; left:50%; transform:translateX(-50%); color:var(--accent); font-weight:bold; font-size:0.9rem;">CLICK TO LIFT!</div>
                `;

                const hammer = document.getElementById('hammer-fall');
                let hammerY = 50;
                let fallSpeed = 0.5;
                let clicks = 0;
                const clickGoal = 2;

                const gameLoop = setInterval(() => {
                    if (!document.getElementById('game-zone')) return clearInterval(gameLoop);

                    fallSpeed += 0.01; 
                    hammerY += fallSpeed;
                    hammer.style.top = hammerY + 'px';

                    gScore.innerText = clicks;
                    updateProgress(clicks, clickGoal);

                    // Victory - hammer reaches top
                    if (hammerY < -20) {
                        clearInterval(gameLoop);
                        rizzSound.play();
                        showEndGameMenu("HAMMER SAVED! YOUR TOES ARE SAFE! üéâ", { hammer: 2 }, type);
                    }

                    // Defeat - hammer hits foot
                    if (hammerY > 280) {
                        clearInterval(gameLoop);
                        ouch.play();
                        showEndGameMenu("OUCH! THAT'S GONNA HURT! ü§ï", { hammer: 0 }, type);
                    }
                }, 30);

                hammer.onclick = () => {
                    hammerY -= 35; 
                    clicks++;
                    mario_jump.play();

                    if (clicks >= clickGoal) {
                        clearInterval(gameLoop);
                        rizzSound.play();
                        showEndGameMenu("HAMMER MASTER! üî®", { hammer: 2 }, type);
                    }
                };
            }

            if (type === 'rockmining') {
                let totalMined = 0;
                let currentRockIndex = 0;
                const rocks = [
                    { clicks: 5, emoji: 'ü™®', health: 5 },
                    { clicks: 10, emoji: '‚õ∞Ô∏è', health: 10 },
                    { clicks: 15, emoji: 'üóø', health: 15 },
                    { clicks: 20, emoji: 'üíé', health: 20 }
                ];

                const spawnRock = () => {
                    if (currentRockIndex >= rocks.length) {
                        showEndGameMenu("ALL METAL MINED! üéâ", { miner: 2 }, type);
                        return;
                    }

                    const rock = rocks[currentRockIndex];
                    let rockHealth = rock.health;

                    zone.innerHTML = `
                        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); text-align:center;">
                            <div id="rock" style="font-size:6rem; cursor:pointer; user-select:none; transition: transform 0.1s;">${rock.emoji}</div>
                            <div style="color:var(--accent); font-weight:bold; font-size:1.2rem; margin-top:10px;">Clics restants: <span id="rock-health">${rockHealth}</span>/${rock.clicks}</div>
                            <div style="color:var(--text); font-size:0.9rem; margin-top:5px;">Rocher ${currentRockIndex + 1}/4</div>
                        </div>
                    `;

                    const rockElement = document.getElementById('rock');
                    const healthDisplay = document.getElementById('rock-health');

                    rockElement.onclick = () => {
                        if (rockHealth > 0) {
                            rockHealth--;
                            healthDisplay.innerText = rockHealth;
                            
                            // Visual feedback
                            rockElement.style.transform = 'translate(-50%, -50%) scale(0.9)';
                            setTimeout(() => {
                                rockElement.style.transform = 'translate(-50%, -50%) scale(1)';
                            }, 100);

                            // Sound effect
                            rockMiningSound.currentTime = 0;
                            rockMiningSound.play();

                            totalMined++;
                            gScore.innerText = totalMined;
                            updateProgress(currentRockIndex * 12.5 + (rock.clicks - rockHealth) / rock.clicks * 12.5, 50);

                            if (rockHealth === 0) {
                                rockElement.innerHTML = '‚ú®';
                                rizzSound.play();
                                setTimeout(() => {
                                    currentRockIndex++;
                                    spawnRock();
                                }, 500);
                            }
                        }
                    };
                };

                spawnRock();
            }

            if (type === 'rythmicForge') {
                let forgeScore = 0;
                let phase = 1;
                
                // Helper function to create sparks
                const createSparks = (x, y, count = 8) => {
                    for (let i = 0; i < count; i++) {
                        const spark = document.createElement('div');
                        spark.className = 'spark';
                        const angle = (Math.PI * 2 * i) / count;
                        const distance = 50 + Math.random() * 30;
                        spark.style.setProperty('--tx', `${Math.cos(angle) * distance}px`);
                        spark.style.setProperty('--ty', `${Math.sin(angle) * distance}px`);
                        spark.style.left = x + 'px';
                        spark.style.top = y + 'px';
                        zone.appendChild(spark);
                        setTimeout(() => spark.remove(), 800);
                    }
                };

                // PHASE 1: Heat the Metal
                const startPhase1 = () => {
                    zone.innerHTML = `
                        <div style="position:absolute; top:20%; left:50%; transform:translateX(-50%); text-align:center; width:90%;">
                            <h2 style="color:var(--accent); margin:0 0 20px 0; font-size:1.8rem;">üî• PHASE 1: Chauffe le M√©tal</h2>
                            <p style="font-size:0.9rem; margin:0 0 30px 0;">Clique quand l'indicateur est dans la zone verte!</p>
                            <div style="position:relative; width:100%; height:40px; background:#334155; border-radius:20px; margin:20px 0; overflow:hidden;">
                                <div id="optimal-zone" style="position:absolute; left:40%; width:20%; height:100%; background:#22c55e; opacity:0.3;"></div>
                                <div id="temp-indicator" style="position:absolute; left:0%; width:4px; height:100%; background:var(--accent); box-shadow:0 0 10px var(--accent); transition:left 0.05s linear;"></div>
                            </div>
                            <div style="color:var(--accent); font-weight:bold; font-size:1.2rem;">Succ√®s: <span id="phase1-score">0</span>/3</div>
                            <div style="margin-top:20px; font-size:0.8rem; opacity:0.7;">Appuie sur ESPACE ou clique!</div>
                        </div>
                    `;

                    const indicator = document.getElementById('temp-indicator');
                    let position = 0;
                    let direction = 1;
                    let successCount = 0;
                    let missCount = 0;
                    const speed = 1.5;

                    const oscillate = setInterval(() => {
                        position += direction * speed;
                        if (position >= 96) direction = -1;
                        if (position <= 0) direction = 1;
                        indicator.style.left = position + '%';
                    }, 16);

                    const checkHit = () => {
                        if (position >= 40 && position <= 60) {
                            successCount++;
                            forgeScore += 100;
                            document.getElementById('phase1-score').innerText = successCount;
                            rizzSound.play();
                            createSparks(zone.offsetWidth / 2, 150, 12);
                            
                            if (successCount >= 3) {
                                clearInterval(oscillate);
                                zone.removeEventListener('click', checkHit);
                                document.removeEventListener('keydown', keyHandler);
                                setTimeout(() => {
                                    phase = 2;
                                    updateProgress(33, 100);
                                    startPhase2();
                                }, 800);
                            }
                        } else {
                            missCount++;
                            forgeScore -= 20;
                            fartSound.play();
                            zone.classList.add('shake');
                            setTimeout(() => zone.classList.remove('shake'), 200);
                        }
                    };

                    const keyHandler = (e) => {
                        if (e.code === 'Space') {
                            e.preventDefault();
                            checkHit();
                        }
                    };

                    zone.addEventListener('click', checkHit);
                    document.addEventListener('keydown', keyHandler);
                };

                // PHASE 2: Assemble Materials
                const startPhase2 = () => {
                    zone.innerHTML = `
                        <div style="position:absolute; top:15%; left:50%; transform:translateX(-50%); text-align:center; width:90%;">
                            <h2 style="color:var(--accent); margin:0 0 15px 0; font-size:1.8rem;">üî® PHASE 2: Assemble les Pi√®ces</h2>
                            <p style="font-size:0.9rem; margin:0 0 20px 0;">Clique pour verrouiller chaque pi√®ce au bon moment!</p>
                        </div>
                        <div style="position:absolute; top:40%; left:50%; transform:translateX(-50%); width:80%;">
                            <div style="position:relative; height:60px; border:2px dashed var(--accent); border-radius:10px; margin-bottom:30px;">
                                <div style="position:absolute; left:50%; top:50%; transform:translate(-50%, -50%); color:var(--accent); opacity:0.3; font-size:3rem;">ü™µ</div>
                                <div id="wood-piece" style="position:absolute; left:0%; top:50%; transform:translateY(-50%); font-size:3rem; transition:left 0.05s linear;">ü™µ</div>
                            </div>
                            <div style="position:relative; height:60px; border:2px dashed var(--accent); border-radius:10px;">
                                <div style="position:absolute; left:50%; top:50%; transform:translate(-50%, -50%); color:var(--accent); opacity:0.3; font-size:3rem;">üî®</div>
                                <div id="metal-piece" style="position:absolute; left:0%; top:50%; transform:translateY(-50%); font-size:3rem; transition:left 0.05s linear;">üî®</div>
                            </div>
                        </div>
                        <div style="position:absolute; bottom:20px; left:50%; transform:translateX(-50%); color:var(--text); font-size:0.8rem;">Clique quand les pi√®ces sont align√©es!</div>
                    `;

                    const woodPiece = document.getElementById('wood-piece');
                    const metalPiece = document.getElementById('metal-piece');
                    let woodPos = 0;
                    let metalPos = 0;
                    let woodDirection = 1;
                    let metalDirection = 1;
                    let woodLocked = false;
                    let metalLocked = false;
                    const speed = 1.2;

                    const slideInterval = setInterval(() => {
                        if (!woodLocked) {
                            woodPos += woodDirection * speed;
                            if (woodPos >= 70) woodDirection = -1;
                            if (woodPos <= 0) woodDirection = 1;
                            woodPiece.style.left = woodPos + '%';
                        }

                        if (!metalLocked) {
                            metalPos += metalDirection * speed * 1.3;
                            if (metalPos >= 70) metalDirection = -1;
                            if (metalPos <= 0) metalDirection = 1;
                            metalPiece.style.left = metalPos + '%';
                        }
                    }, 16);

                    const lockPiece = () => {
                        if (!woodLocked) {
                            woodLocked = true;
                            const accuracy = Math.abs(50 - woodPos);
                            if (accuracy < 10) {
                                forgeScore += 150;
                                woodPiece.style.left = '50%';
                                woodPiece.style.transform = 'translateY(-50%) translateX(-50%)';
                                woodPiece.style.animation = 'glow 0.5s ease';
                                rizzSound.play();
                                createSparks(zone.offsetWidth / 2, zone.offsetHeight * 0.45, 8);
                            } else if (accuracy < 25) {
                                forgeScore += 75;
                                cartoonHammerSound.currentTime = 0;
                                cartoonHammerSound.play();
                            } else {
                                forgeScore += 20;
                                fartSound.play();
                            }
                        } else if (!metalLocked) {
                            metalLocked = true;
                            const accuracy = Math.abs(50 - metalPos);
                            if (accuracy < 10) {
                                forgeScore += 150;
                                metalPiece.style.left = '50%';
                                metalPiece.style.transform = 'translateY(-50%) translateX(-50%)';
                                metalPiece.style.animation = 'glow 0.5s ease';
                                rizzSound.play();
                                createSparks(zone.offsetWidth / 2, zone.offsetHeight * 0.6, 8);
                            } else if (accuracy < 25) {
                                forgeScore += 75;
                                cartoonHammerSound.currentTime = 0;
                                cartoonHammerSound.play();
                            } else {
                                forgeScore += 20;
                                fartSound.play();
                            }

                            clearInterval(slideInterval);
                            zone.removeEventListener('click', lockPiece);
                            setTimeout(() => {
                                phase = 3;
                                updateProgress(66, 100);
                                startPhase3();
                            }, 1000);
                        }
                    };

                    zone.addEventListener('click', lockPiece);
                };

                // PHASE 3: Rhythmic Strikes
                const startPhase3 = () => {
                    zone.innerHTML = `
                        <div style="position:absolute; top:15%; left:50%; transform:translateX(-50%); text-align:center; width:90%;">
                            <h2 style="color:var(--accent); margin:0 0 15px 0; font-size:1.6rem;">‚ö° PHASE 3: Frappes Rythmiques</h2>
                        </div>
                        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);">
                            <div id="target-zone" style="width:120px; height:120px; border:4px dashed var(--accent); border-radius:50%; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1; opacity:0.5;"></div>
                            <div id="closing-circle" style="width:250px; height:250px; border:8px solid #22c55e; border-radius:50%; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); transition:none; z-index:2; background:rgba(34, 197, 94, 0.1);"></div>
                        </div>
                        <div style="position:absolute; bottom:30px; left:50%; transform:translateX(-50%); text-align:center; width:90%; z-index:10;">
                            <p style="font-size:0.9rem; margin:0 0 10px 0;">Frappe quand le cercle atteint le centre!</p>
                            <div style="color:var(--accent); font-weight:bold; font-size:1.2rem;">Frappes: <span id="strikes">0</span>/5</div>
                            <div style="margin-top:10px; color:var(--text); font-size:0.8rem;">Appuie sur ESPACE ou clique!</div>
                        </div>
                    `;

                    const closingCircle = document.getElementById('closing-circle');
                    const strikesDisplay = document.getElementById('strikes');
                    const targetZone = document.getElementById('target-zone');
                    let strikes = 0;
                    let isClosing = false;
                    let resetTimeout = null;

                    const startStrike = () => {
                        if (isClosing) return;
                        isClosing = true;
                        
                        // Clear any existing timeouts
                        if (resetTimeout) clearTimeout(resetTimeout);
                        
                        // Reset circle to large size
                        closingCircle.style.transition = 'none';
                        closingCircle.style.width = '250px';
                        closingCircle.style.height = '250px';
                        closingCircle.style.borderColor = '#22c55e';
                        closingCircle.style.background = 'rgba(34, 197, 94, 0.1)';

                        setTimeout(() => {
                            closingCircle.style.transition = 'width 2.5s linear, height 2.5s linear';
                            closingCircle.style.width = '10px';
                            closingCircle.style.height = '10px';
                        }, 50);

                        // Auto-reset if player doesn't click in time
                        resetTimeout = setTimeout(() => {
                            if (isClosing) {
                                setTimeout(() => zone.classList.remove('shake'), 200);
                                isClosing = false;
                                if (strikes < 5) {
                                    setTimeout(() => startStrike(), 300);
                                }
                            }
                        }, 2600);
                    };

                    const checkStrike = () => {
                        if (!isClosing) return;

                        // Clear the reset timeout
                        if (resetTimeout) clearTimeout(resetTimeout);

                        // Get the computed style to see the actual current size during animation
                        const computedStyle = window.getComputedStyle(closingCircle);
                        const currentSize = parseFloat(computedStyle.width);
                        
                        console.log('Current circle size:', currentSize); // Debug log

                        const targetSize = 120; // Target zone size
                        const minSize = 100;
                        const maxSize = 140;

                        // Check if circle is within the target zone margin
                        if (currentSize >= minSize && currentSize <= maxSize) {
                            forgeScore += 200;
                            strikes++;
                            strikesDisplay.innerText = strikes;
                            pewpew.currentTime = 0;
                            pewpew.play();
                            createSparks(zone.offsetWidth / 2, zone.offsetHeight / 2, 16);
                            closingCircle.style.borderColor = '#22c55e';
                            closingCircle.style.background = 'rgba(34, 197, 94, 0.3)';
                            targetZone.style.borderColor = '#22c55e';
                            targetZone.style.opacity = '1';
                        } else if ((currentSize >= 80 && currentSize < minSize) || (currentSize > maxSize && currentSize <= 160)) {
                            forgeScore += 100;
                            strikes++;
                            strikesDisplay.innerText = strikes;
                            awSound.play();
                            closingCircle.style.borderColor = '#f59e0b';
                            closingCircle.style.background = 'rgba(245, 158, 11, 0.2)';
                            targetZone.style.borderColor = '#f59e0b';
                        } else {
                            forgeScore += 30;
                            strikes++;
                            strikesDisplay.innerText = strikes;
                            fartSound.play();
                            closingCircle.style.borderColor = '#dc2626';
                            closingCircle.style.background = 'rgba(220, 38, 38, 0.2)';
                            targetZone.style.borderColor = '#dc2626';
                        }

                        updateProgress(66 + (strikes / 5) * 34, 100);
                        isClosing = false;

                        if (strikes >= 5) {
                            zone.removeEventListener('click', checkStrike);
                            document.removeEventListener('keydown', keyHandler3);
                            setTimeout(() => showFinalHammer(), 800);
                        } else {
                            setTimeout(() => {
                                targetZone.style.borderColor = 'var(--accent)';
                                targetZone.style.opacity = '0.5';
                                startStrike();
                            }, 600);
                        }
                    };

                    const keyHandler3 = (e) => {
                        if (e.code === 'Space') {
                            e.preventDefault();
                            checkStrike();
                        }
                    };

                    zone.addEventListener('click', checkStrike);
                    document.addEventListener('keydown', keyHandler3);
                    startStrike();
                };

                // Final Hammer Display
                const showFinalHammer = () => {
                    let quality, message, hammerEmoji;
                    if (forgeScore >= 1000) {
                        quality = "L√âGENDAIRE";
                        message = "Un chef-d'≈ìuvre de forgeron! üåü";
                        hammerEmoji = "üî®‚ú®";
                    } else if (forgeScore >= 600) {
                        quality = "SOLIDE";
                        message = "Un marteau de qualit√©! üí™";
                        hammerEmoji = "üî®";
                    } else {
                        quality = "BASIQUE";
                        message = "Un bon d√©but de bricoleur! üëç";
                        hammerEmoji = "üî®";
                    }

                    zone.innerHTML = `
                        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); text-align:center;">
                            <div style="font-size:5rem; animation:pulse 1s infinite;">${hammerEmoji}</div>
                            <h2 style="color:var(--accent); margin:20px 0 10px 0; font-size:2rem;">MARTEAU ${quality}</h2>
                            <p style="font-size:1rem; margin:0;">${message}</p>
                            <p style="font-size:1.5rem; font-weight:bold; color:#22c55e; margin:20px 0;">Score: ${forgeScore}</p>
                        </div>
                    `;

                    // Create celebration sparks
                    const celebrateInterval = setInterval(() => {
                        createSparks(
                            zone.offsetWidth / 2 + (Math.random() - 0.5) * 100,
                            zone.offsetHeight / 2 + (Math.random() - 0.5) * 100,
                            6
                        );
                    }, 200);

                    rizzSound.play();

                    setTimeout(() => {
                        clearInterval(celebrateInterval);
                        showEndGameMenu(`Marteau ${quality} Forg√©! üî®`, { forge: forgeScore >= 600 ? 2 : 1 }, type);
                    }, 3000);
                };

                // Start the game
                gScore.innerText = '0';
                updateProgress(0, 100);
                startPhase1();
            }



        };


        function renderResult() {
            const s = state.scores;
            let title, gift;
            if (s.security > s.gaffeur && s.security > s.bricoleur) {
                title = "SAFETY CHAMPION üî®"; gift = "Tu m√©rites un bel outil pour ta peine! On n'a pas besoin de te le rappeler tu sais que la protection est primordiale!";
            } else if (s.bricoleur > s.gaffeur) {
                title = "THE MASTER CRAFTSMAN ü™µ"; gift = "le plus beau cadeau pour un bricoleur passionn√©! Un magnifique marteau!";
            } else {
                title = "THE GAFFEUR ü§ï"; gift = "On ne fait pas d'omelettes sans casser des oeufs! Utilise cet outil avec prudence!";
            }
            app.innerHTML = `
                <div class="card">
                    <h1>${title}</h1>
                    <p>S√©curit√© ${s.security} | Gaffeur ${s.gaffeur} | Bricoleur ${s.bricoleur}</p>
                    <img src="Matt_gift.png" alt="Your Gift" style="max-width: 100%; height: auto; border-radius: 1rem; margin: 20px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                    <p style="font-size: 1.1rem; margin-top: 20px;">${gift}</p>
                    <button onclick="window.location.reload()" style="margin-top: 20px;">Recommencer</button>
                </div>
            `;
        }

        render();
    </script>
</body>

</html>